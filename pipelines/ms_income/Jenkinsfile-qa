pipeline {
    agent any

    environment {
        DOCKER_HUB_REPO = 'miguel1203/gestion-income'
        IMAGE_TAG = 'qa'
        DOCKER_USER = 'miguel1203'
        DOCKER_PASS = 'dckr_pat_5CQzKCl99YfG_0nuHQMiuxUw6AY'
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out code...'
                checkout scm
            }
        }

        stage('Build Application') {
            steps {
                echo 'Building Spring Boot Income Service...'
                dir('Back/ms_income') {
                    sh 'chmod +x ./mvnw'
                    sh './mvnw clean package -DskipTests'
                }
            }
        }

        stage('Copy JAR to Dockerfile location') {
            steps {
                echo 'Copying JAR to Dockerfile location...'
                sh '''
                    mkdir -p ./Back/ms_income/target
                    cp ./Back/ms_income/target/*.jar ./Back/ms_income/target/ || echo "JAR already in correct location"
                '''
            }
        }

        stage('Build and Push Docker Image') {
            steps {
                echo 'Building and pushing Docker image for Income Service...'
                dir('Back/ms_income') {
                    script {
                        sh 'echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin'

                        def image = docker.build("${DOCKER_HUB_REPO}:${IMAGE_TAG}")
                        image.push()
                    }
                }
            }
        }

        stage('Deploy Application') {
            steps {
                echo 'Deploying Income Service QA...'
                sh '''
                    echo "ðŸš€ Desplegando Income Service QA..."
                    docker network create gestios-gastos-back-qa || true
                    docker network connect gestios-gastos-back-qa DataBase-qa || true

                    docker stop msincome-qa || true
                    docker rm msincome-qa || true

                    docker run -d \
                      --name msincome-qa \
                      --network gestion-gastos-qa_default \
                      -p 8101:8100 \
                      -e SPRING_PROFILES_ACTIVE=qa \
                      -e SPRING_DATASOURCE_URL="jdbc:postgresql://DataBase-qa:5432/gestion_gastos_qa" \
                      -e SPRING_DATASOURCE_USERNAME=postgres \
                      -e SPRING_DATASOURCE_PASSWORD=qa123456 \
                      -e CATEGORIES_SERVICE_URL=http://mscategories-qa:8090 \
                      ${DOCKER_HUB_REPO}:${IMAGE_TAG}
                '''
            }
        }


    }
}
